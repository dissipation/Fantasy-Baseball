---
title: "Fantasy Baseball Model Hitting"
author: "Darshan Patel"
date: "2/26/2022"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:\\Users\\Admin\\Documents\\Learning Python Folder1\\Fantasy Baseball Model')
```

```{r}
library(stringr)
library(tidyverse)
library(sqldf)
library(rvest)
library(stringi)
library(skimr)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(caret)
library(xgboost)
library(Matrix)
library(vtreat)
```


https://cran.r-project.org/web/packages/ParBayesianOptimization/vignettes/tuningHyperparameters.html
https://www.kaggle.com/silverstone1903/xgboost-grid-search-r/notebook
https://www.kaggle.com/pelkoja/visual-xgboost-tuning-with-caret
```{r load-data}

data(LahmanData, package="Lahman")
str(LahmanData) #take a look at the data

LahmanData$file #gives names of all files

#Reading in Data up to 2020, 2021 data is scraped in another notebook from MLB.com
    data(   AllstarFull   , package="Lahman")     

  data(  Appearances        , package="Lahman")

  data( AwardsManagers     , package="Lahman")

  data(AwardsPlayers    , package="Lahman")
data(AwardsShareManagers, package="Lahman")
data(AwardsSharePlayers, package="Lahman")
 data(   Batting           , package="Lahman")
data(    BattingPost        , package="Lahman")
data( CollegePlaying , package="Lahman")
data(  Fielding           , package="Lahman")
 data( FieldingOF       , package="Lahman")
data(  FieldingPost       , package="Lahman")

  data(  HomeGames         , package="Lahman")
  data(  HallOfFame         , package="Lahman")
 data( Managers        , package="Lahman")
 data(  ManagersHalf     , package="Lahman")
  data( Master             , package="Lahman")
  data(  Parks         , package="Lahman")
data(  Pitching         , package="Lahman")
data(  PitchingPost     , package="Lahman")
 data(Salaries        , package="Lahman")
  data(  Schools            , package="Lahman")
 data( SeriesPost      , package="Lahman")
data(  Teams           , package="Lahman")
 data( TeamsFranchises   , package="Lahman")
    data(TeamsHalf  , package="Lahman")

    
        data(People  , package="Lahman")

   
```


```{r}


```

### 2015+ Models

```{r}

#Will only focus on Players, Teams and Stadiums from 2015 Onward for the Purposes for creating a model

#At least 24 At_bats to qualify
Batting_LH_GTHAN_2015 = subset(Batting,yearID > 2014 & AB > 24)

Pitching_LH_GTHAN_2015 = subset(Pitching,yearID > 2014)

Teams_LH_GTHAN_2015 = subset(Teams,yearID > 2014)

#People_LH_GTHAN_2015 = subset(People,yearID > 2014)

#Addition one additional year incase people retired
Master_LH_GTHAN_2015 = subset(Master,finalGame > '2014-01-01')

HomeGames_LH_GTHAN_2015 = subset(HomeGames,year.key > 2014)

Managers_LH_GTHAN_2015 = subset(Managers,yearID > 2014)

AwardsPlayers_LH_GTHAN_2015   =   subset(AwardsPlayers,yearID > 2014)


Batting_LH_GTHAN_2015

Master_LH_GTHAN_2015

```


#### 2021 Data - Fantasy Pros
```{r}
#HMM this is missing a few stats found in Lahman, but we can use VBR as a pseudo scoring mechanism
URL2021_Actual = read_html('https://www.fantasypros.com/mlb/stats/hitters.php?range=2021&page=ALL')


batting_2021 = 
  URL2021_Actual %>% 
  html_nodes(xpath ='//*[@id="main-container"]/div/div/div/div[6]') %>% 
  html_table()


batting_2021 = batting_2021[[1]]

batting_2021

```

#### 2021 Data - MLB
```{r}


#Additional 2021 Stats-Current Players
Adv_stats1 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&playerPool=ALL_CURRENT')
Adv_stats2 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=2&playerPool=ALL_CURRENT')

Adv_stats3 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=3&playerPool=ALL_CURRENT')

Adv_stats4 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=4&playerPool=ALL_CURRENT')

Adv_stats5 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=5&playerPool=ALL_CURRENT')

Adv_stats6 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=6&playerPool=ALL_CURRENT')

Adv_stats7 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=7&playerPool=ALL_CURRENT')

Adv_stats8 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=8&playerPool=ALL_CURRENT')

Adv_stats9 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=9&playerPool=ALL_CURRENT')


Adv_stats10 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=10&playerPool=ALL_CURRENT')

Adv_stats11 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=11&playerPool=ALL_CURRENT')

Adv_stats12 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=12&playerPool=ALL_CURRENT')

Adv_stats13 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=13&playerPool=ALL_CURRENT')

Adv_stats14 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=14&playerPool=ALL_CURRENT')

Adv_stats15 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=15&playerPool=ALL_CURRENT')

Adv_stats16 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=16&playerPool=ALL_CURRENT')


Adv_stats17 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=17&playerPool=ALL_CURRENT')

Adv_stats18 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=18&playerPool=ALL_CURRENT')

Adv_stats19 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=19&playerPool=ALL_CURRENT')

Adv_stats20 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=20&playerPool=ALL_CURRENT')

Adv_stats21 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=21&playerPool=ALL_CURRENT')

Adv_stats22 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=22&playerPool=ALL_CURRENT')

Adv_stats23 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=23&playerPool=ALL_CURRENT')

Adv_stats24 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=24&playerPool=ALL_CURRENT')

Adv_stats25 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=25&playerPool=ALL_CURRENT')

Adv_stats26 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=26&playerPool=ALL_CURRENT')

Adv_stats27 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=27&playerPool=ALL_CURRENT')

Adv_stats28 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=28&playerPool=ALL_CURRENT')

Adv_stats29 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=29&playerPool=ALL_CURRENT')

Adv_stats30 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=30&playerPool=ALL_CURRENT')

Adv_stats31 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=31&playerPool=ALL_CURRENT')

Adv_stats32 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=32&playerPool=ALL_CURRENT')

Adv_stats33 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=33&playerPool=ALL_CURRENT')

Adv_stats34 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=34&playerPool=ALL_CURRENT')

Adv_stats35 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=35&playerPool=ALL_CURRENT')

Adv_stats36 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=36&playerPool=ALL_CURRENT')

Adv_stats37 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=37&playerPool=ALL_CURRENT')

Adv_stats38 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=38&playerPool=ALL_CURRENT')

Adv_stats39 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=39&playerPool=ALL_CURRENT')

Adv_stats40 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=40&playerPool=ALL_CURRENT')

Adv_stats41 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=41&playerPool=ALL_CURRENT')

Adv_stats42 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=42&playerPool=ALL_CURRENT')

Adv_stats43 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=43&playerPool=ALL_CURRENT')

Adv_stats44 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=44&playerPool=ALL_CURRENT')

Adv_stats45 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=45&playerPool=ALL_CURRENT')

Adv_stats46 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=46&playerPool=ALL_CURRENT')

Adv_stats47 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=47&playerPool=ALL_CURRENT')

Adv_stats48 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=48&playerPool=ALL_CURRENT')

Adv_stats49 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=49&playerPool=ALL_CURRENT')

Adv_stats50 = read_html('https://www.mlb.com/stats/plate-appearances?expanded=true&page=50&playerPool=ALL_CURRENT')


Adv_stats1 = 
  Adv_stats1 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats1 = Adv_stats1[[1]]


Adv_stats2 = 
  Adv_stats2 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats2 = Adv_stats2[[1]]

Adv_stats3 = 
  Adv_stats3 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats3 = Adv_stats3[[1]]

Adv_stats4 = 
  Adv_stats4 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats4 = Adv_stats4[[1]]

Adv_stats5 = 
  Adv_stats5 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats5 = Adv_stats5[[1]]


Adv_stats6 = 
  Adv_stats6 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats6 = Adv_stats6[[1]]

Adv_stats7 = 
  Adv_stats7 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats7 = Adv_stats7[[1]]

Adv_stats8 = 
  Adv_stats8 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats8 = Adv_stats8[[1]]

Adv_stats9 = 
  Adv_stats9 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats9 = Adv_stats9[[1]]

Adv_stats10 = 
  Adv_stats10 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats10 = Adv_stats10[[1]]


Adv_stats11 = 
  Adv_stats11 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats11 = Adv_stats11[[1]]

Adv_stats12 = 
  Adv_stats12 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats12 = Adv_stats12[[1]]

Adv_stats13 = 
  Adv_stats13 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats13 = Adv_stats13[[1]]

Adv_stats14 = 
  Adv_stats14 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats14 = Adv_stats14[[1]]

Adv_stats15 = 
  Adv_stats15 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats15 = Adv_stats15[[1]]


Adv_stats16 = 
  Adv_stats16 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats16 = Adv_stats16[[1]]

Adv_stats17 = 
  Adv_stats17 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats17 = Adv_stats17[[1]]

Adv_stats18 = 
  Adv_stats18 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats18 = Adv_stats18[[1]]

Adv_stats19 = 
  Adv_stats19 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats19 = Adv_stats19[[1]]

Adv_stats20 = 
  Adv_stats20 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats20 = Adv_stats20[[1]]

Adv_stats21 = 
  Adv_stats21 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats21 = Adv_stats21[[1]]

Adv_stats22 = 
  Adv_stats22 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats22 = Adv_stats22[[1]]

Adv_stats23 = 
  Adv_stats23 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats23 = Adv_stats23[[1]]

Adv_stats24 = 
  Adv_stats24 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats24 = Adv_stats24[[1]]

Adv_stats25 = 
  Adv_stats25 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats25 = Adv_stats25[[1]]


Adv_stats26 = 
  Adv_stats26 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats26 = Adv_stats26[[1]]


Adv_stats27 = 
  Adv_stats27 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats27 = Adv_stats27[[1]]

Adv_stats28 = 
  Adv_stats28 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats28 = Adv_stats28[[1]]

Adv_stats29 = 
  Adv_stats29 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats29 = Adv_stats29[[1]]

Adv_stats30 = 
  Adv_stats30 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats30 = Adv_stats30[[1]]

Adv_stats31 = 
  Adv_stats31 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats31 = Adv_stats31[[1]]

Adv_stats32 = 
  Adv_stats32 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats32 = Adv_stats32[[1]]

Adv_stats33 = 
  Adv_stats33 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats33 = Adv_stats33[[1]]

Adv_stats34 = 
  Adv_stats34 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats34 = Adv_stats34[[1]]

Adv_stats35 = 
  Adv_stats35 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats35 = Adv_stats35[[1]]


Adv_stats36 = 
  Adv_stats36 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats36 = Adv_stats36[[1]]


Adv_stats37 = 
  Adv_stats37 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats37 = Adv_stats37[[1]]

Adv_stats38 = 
  Adv_stats38 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats38 = Adv_stats38[[1]]

Adv_stats39 = 
  Adv_stats39 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats39 = Adv_stats39[[1]]

Adv_stats40 = 
  Adv_stats40 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats40 = Adv_stats40[[1]]

Adv_stats41 = 
  Adv_stats41 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats41 = Adv_stats41[[1]]

Adv_stats42 = 
  Adv_stats42 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats42 = Adv_stats42[[1]]

Adv_stats43 = 
  Adv_stats43 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats43 = Adv_stats43[[1]]

Adv_stats44 = 
  Adv_stats44 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats44 = Adv_stats44[[1]]

Adv_stats45 = 
  Adv_stats45 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats45 = Adv_stats45[[1]]


Adv_stats46 = 
  Adv_stats46 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats46 = Adv_stats46[[1]]


Adv_stats47 = 
  Adv_stats47 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats47 = Adv_stats47[[1]]

Adv_stats48 = 
  Adv_stats48 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats48 = Adv_stats48[[1]]

Adv_stats49 = 
  Adv_stats49 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats49 = Adv_stats49[[1]]

Adv_stats50 = 
  Adv_stats50 %>% 
  html_nodes(xpath ='//*[@id="stats-app-root"]/section/section/div[3]') %>% 
  html_table()

Adv_stats50 = Adv_stats50[[1]]



Adv_stats = rbind(Adv_stats1,Adv_stats2,Adv_stats3,Adv_stats4,Adv_stats5,Adv_stats6,Adv_stats7,Adv_stats8,Adv_stats9,Adv_stats10,Adv_stats11,Adv_stats12,Adv_stats13,Adv_stats14,Adv_stats15,Adv_stats16,Adv_stats17,Adv_stats18,Adv_stats19,Adv_stats20,Adv_stats21,Adv_stats22,Adv_stats23,Adv_stats24,Adv_stats25,Adv_stats26,Adv_stats27,Adv_stats28,Adv_stats29,Adv_stats30,Adv_stats31,Adv_stats32,Adv_stats33,Adv_stats34,Adv_stats35,Adv_stats36,Adv_stats37,Adv_stats38,Adv_stats39,Adv_stats40,Adv_stats41,Adv_stats42,Adv_stats43,Adv_stats44,Adv_stats45,Adv_stats46,Adv_stats47,Adv_stats48,Adv_stats49,Adv_stats50
              )

Adv_stats


```

### CLeaning up names and Regular Expressions for both files
```{r}

Adv_stats_Clean1 = Adv_stats %>% 
  mutate(
    nameGiven2 = gsub("[0-9]+","",PLAYERPLAYER)
    )
  

#Delimit the data
Adv_stats_Clean2 <- cbind(Adv_stats_Clean1, stringr::str_split_fixed(Adv_stats_Clean1$nameGiven2, " ", 2))

names(Adv_stats_Clean2) = c("PLAYER","TEAM","PA" , "HBP"  ,"SAC", "SF",               	
"GIDP"                 ,                "GO/AO"                        ,      	
"XBHXBH"                  ,                 "TBTB"                          ,          	
"IBB"                     ,              "BABIP"                  ,            	
"ISO"                       ,            "AB/HR"                ,              	
"BB/K"             ,                    "BB%"                 ,                 	
	"SO%"                ,                   "nameGiven2"            ,                  	
	"Col1"               ,                         "Col2"     	)



  
Adv_stats_Clean3 = Adv_stats_Clean2 %>% 
  mutate(
    nameGiven3a = str_sub(Col2, -nchar(Col2), nchar(Col2)-3 )
    )


```

```{r}
    
Adv_stats_Clean3[21]
```


```{r}



#Everything except for Jr. is accounted for

Adv_stats_Clean4 =  Adv_stats_Clean3 %>% 
  mutate(
    First_name = str_sub(Col1,-nchar(Col1), nchar(Col1)-1)
    ,
    Second_Name = ifelse(str_sub(nameGiven3a,-1, -1) == "B" ,str_sub(nameGiven3a ,-nchar(nameGiven3a )*2, nchar(nameGiven3a)/2) , str_sub(nameGiven3a ,-nchar(nameGiven3a )*2, nchar(nameGiven3a)/2-1)))
      
    
#Everything  Most Players is accounted for with this, but most are close enough for a fuzzy join

Adv_stats_Clean4a =  Adv_stats_Clean3 %>% 
  mutate(
    First_name = str_sub(Col1,-nchar(Col1), nchar(Col1)-1)
    ,
    Second_Name = ifelse(str_sub(nameGiven3a,-1, -1) %in% c("C","B","X"),str_sub(nameGiven3a ,-nchar(nameGiven3a )*2, nchar(nameGiven3a)/2) , ifelse((str_sub(str_sub(nameGiven3a ,-nchar(nameGiven3a )*2, nchar(nameGiven3a)/2-1),-2,-1)) == " J",str_sub(nameGiven3a ,-nchar(nameGiven3a )*2, nchar(nameGiven3a)/2+1),str_sub(nameGiven3a ,-nchar(nameGiven3a )*2, nchar(nameGiven3a)/2-1))))
      
      
Adv_stats_Clean4a[21:23]
      

#str_sub(str_sub(Adv_stats_Clean4$nameGiven3a ,-nchar(Adv_stats_Clean4$nameGiven3a )*2, nchar(Adv_stats_Clean4$nameGiven3a)/2-1),-2,-1)


#(str_sub(Adv_stats_Clean4$nameGiven3a ,-nchar(Adv_stats_Clean4$nameGiven3a )*2, nchar(Adv_stats_Clean4$nameGiven3a)/2-1))

names(Adv_stats_Clean4a)

```

### Clean it all Up - Merge to Rotowire Data  

##### Merge  
```{r}

#Combine names and select columns to keep
Adv_stats_Clean5 = Adv_stats_Clean4a %>% 
  select(22,23, 2:16,21,1) %>% 
  mutate(
    nameGiven = paste(First_name, Second_Name, sep=" ")
    ,yearID = 2021
         ) %>% 
  select(20,21,1:19)

Adv_stats_Clean5



```

##### Import CSV download from Roto

```{r}

write.csv(Adv_stats_Clean5, "Adv_stats_Clean5.csv")

Standard_Stats_Clean <- read_csv("Batters_2021.csv")

playernames1 <- Adv_stats_Clean5$nameGiven

playernames2 <- Standard_Stats_Clean$Player

words <- as_tibble((playernames2))

p1_correct <- playernames1 %>%
    stringdist_inner_join(playernames2, by = c("playernames1" = 'playernames2'), max_dist = 1)
    print (p1_correct)
    


```



Create Scoring Metric for Historical Data - cleaning up batting data
Stint = number of teams in a season
```{r}


statcast_data <- read.csv( "stats_2015_2021.csv")

statcast_data 


Lahman_data <- write.csv(Batting_LH_GTHAN_2015, "Batting_LH_2021.csv")

Master_LH_GTHAN_2015<- write.csv(Master, "Master_LH.csv")

Master_LH_GTHAN_2015

```


#### Read CSV's back

```{r}

statcast_data <- read.csv( "stats_2015_2021.csv")

Lahman_data_lookup  <- read.csv( "PlayerLookup_LH.csv")

Roto2021_data  <- read.csv( "Batters_2021.csv")

#statcast_data

#Lahman_data_lookup

#Roto2021_data


```

### Consolidate data for players with multiple teams

```{r}



Batting_LH_GTHAN_2015_Statcast1 <- sqldf(
  "
select a.* ,b.New_Player_ID from
  Batting_LH_GTHAN_2015 a
  left join 
  Lahman_data_lookup b
  on a.PlayerID = b.PlayerID_2020
  where b.IND >0
  "
)


#Add team_ prefix to team data, create an avg column
# append extra team information
# add ballpark information

Batting_LH_GTHAN_2015_Statcast2 <- sqldf(
  "
select a.*, b.*, c.* from
  Batting_LH_GTHAN_2015_Statcast1 a,
  statcast_data b,
  Teams_LH_GTHAN_2015 c
  on a.New_Player_ID = b.New_Player_ID
  and a.yearID = b.year
  and a.yearID = c.yearID
  and a.lgID = c.lgID
  and a.teamID = c.teamID
  "
) 

Batting_LH_GTHAN_2015_Statcast2


write.csv(Batting_LH_GTHAN_2015_Statcast2,"data_columns.csv")

Teams_LH_GTHAN_2015

write.csv(Teams_LH_GTHAN_2015,"Stadium_Actual2.csv")

```


```{r}
#scraping stadium info


#Getting dimensions of Stadium
Stadium_Actual = read_html('http://www.andrewclem.com/Baseball/Dimensions.html')


Stadium_Actual = 
 Stadium_Actual %>% 
  html_nodes(xpath ='//*[@id="dataTable01"]/tbody') %>% 
  html_table()


Stadium_Actual = Stadium_Actual[[1]]

names(Stadium_Actual) = c('Stadium',	'Team',	'Behind_home_plate','left_field',	'left_center_marked','left_center_actual','center_field_marked','center_field_actual', 'right_center_marked','right_center_actual', 'right_field')

write.csv(Stadium_Actual,"Stadium_Actual1.csv")

Stadium_Actual =  read.csv("Stadium_PFs.csv")

Stadium_Actual

```

### Paring Data for Analysis

#### Don't forget 2020 was a shortened season

```{r}

#Batting_LH_GTHAN_2015_Statcast3 = read_csv("Clean_data.csv")


#Batting_LH_GTHAN_2015_Statcast4 <- sqldf("
 #     select New_Player_ID,	playerID,	player_age,	yearID,	stint,	G,	AB,	R,	H,	X2B,	X3B,	HR,	RBI,	SB,	CS,	BB,	SO,	IBB,	HBP,	SH,	SF,	GIDP,	xba,	xslg,	woba,	xwoba,	xobp,	xiso,	xbadiff,	xslgdiff,	wobadif,	exit_velocity_avg,	launch_angle_avg,	sweet_spot_percent,	barrel_batted_rate,	solidcontact_percent,	flareburner_percent,	poorlyunder_percent,	poorlytopped_percent,	poorlyweak_percent,	hard_hit_percent,	n_bolts,	hp_to_1b,	sprint_speed,	lgID,	teamID,	franchID,	divID,	Rank,	T_G,	Team_W,	Team_L,	T_ADJ_W,	T_ADJ_L,	T_R,	T_AB,	T_H,	T_X2B,	T_X3B,	T_HR,	T_BB,	T_SO,	T_SB,	T_CS,	T_HBP,	T_SF,	T_RA,	T_ER,	T_ERA,	T_CG,	T_SHO,	T_SV,	T_IPouts,	T_HA,	T_HRA,	T_BBA,	T_SOA,	T_E,	T_DP,	T_FP,	T_name,	park,	attendance,	BPF,	PPF,	PF_RUNS,	PF_HR,	PF_Hits,	PF_Doubles,	PF_Triples,	PF_Walks,	PF_SC,	PF_wOBACon,	PF_BACON,	Field_Type_turf,	Dome_type_yes
# from Batting_LH_GTHAN_2015_Statcast3  
 #group by New_Player_ID,playerID
                                        # ")

Batting_LH_GTHAN_2015_Statcast4a <- sqldf("
select New_Player_ID,	playerID,	max(player_age) as player_age_avg,	yearID, max(stint) as stint_max
from Batting_LH_GTHAN_2015_Statcast3  
 group by New_Player_ID,playerID, yearID
 order by New_Player_ID,playerID, yearID
                                         ")


write.csv(Teams2021_Actual_Hitting_Clean,"Teams_2021_clean.csv")

write.csv(Teams2021_clean,"Teams_2021.csv")


#Incorporate 2021 data

Batting_Roto_2021 <- read.csv("Batting_2021_agg_clean_stadium.csv")


# Final clean data
Batting_LH_GTHAN_2015_Statcast5 <-  read.csv("Clean_data_agg.csv")

Batting_Statcast1 <-rbind(Batting_Roto_2021,Batting_LH_GTHAN_2015_Statcast5)
Batting_Statcast2 <- arrange(Batting_Statcast1,New_Player_ID,yearID)


#Convert dataset to numerical where possible


#Batting_Statcast2$lag_H =  c(NA, Batting_Statcast2$H[-nrow(Batting_Statcast2)])
#Batting_Statcast2$lag_H[which(!duplicated(Batting_Statcast2$New_Player_ID))] <- NA


#avg G played per year
#take weighted average by ABs for team values


```

*WOBA:*  
![](C:/Users\\Admin\\Documents\\Learning Python Folder1\\Fantasy Baseball Model\\Img2.png)    

*ISO: *  
![](C:/Users\\Admin\\Documents\\Learning Python Folder1\\Fantasy Baseball Model\\Img3.png)  


### Metric Creation
```{r}


#Create metrics for creating model
#consider adding the plus_statistics which are indexed to the league average
Batting_Statcast3 = Batting_Statcast2 %>% 
  mutate(
    x1h = H - X2B-X3B - HR,
    ba = H/AB,
    slg = (x1h+(X2B)+(X3B*2)+(HR*3))/AB,
    obp = (H+BB+HBP)/(AB+BB+HBP+SF),
    ops = obp+slg,
    iso = ((X2B)+(X3B*2)+(HR*3))/AB,
    gpa = (obp*1.8 + slg)/4,
    ab_per_hr = ifelse(HR < 1 ,0,AB/HR),
    team_x1h = T_H - T_X2B-T_X3B - T_HR,
    #note: woba is already included in statcast
    teamW_perc = Team_W/T_G,
    teamL_perc = Team_L/T_G,
    team_AVG = T_H/T_AB,
    team_slg = (team_x1h+(T_X2B)+(T_X3B*2)+(T_HR*3))/T_AB,
    slg_share =(x1h+(X2B)+(X3B*2)+(HR*3))/ (team_x1h+(T_X2B)+(T_X3B*2)+(T_HR*3)) ,
    team_iso = ((T_X2B)+(T_X3B*2)+(T_HR*3))/AB, 
    xba= as.numeric(xba),
    xslg= as.numeric(xslg),
    woba= as.numeric(woba),
    xwoba= as.numeric(xwoba),
    xobp= as.numeric(xobp),
    xiso= as.numeric(xiso),
    xbadiff= as.numeric(xbadiff),
    xslgdiff= as.numeric(xslgdiff),
    wobadif= as.numeric(wobadif),
    
    exit_velocity_avg= as.numeric(exit_velocity_avg),
    launch_angle_avg= as.numeric(launch_angle_avg),
    
    sweet_spot_percent = as.numeric(sweet_spot_percent),
    barrel_batted_rate= as.numeric(barrel_batted_rate),
    solidcontact_percent= as.numeric(solidcontact_percent),
    flareburner_percent= as.numeric(flareburner_percent),
    poorlyunder_percent= as.numeric(poorlyunder_percent),
    poorlytopped_percent= as.numeric(poorlytopped_percent),
    poorlyweak_percent= as.numeric(poorlyweak_percent),
    hard_hit_percent= as.numeric(hard_hit_percent),
    
    n_bolts= as.numeric(n_bolts),
    hp_to_1b= as.numeric(hp_to_1b),
    sprint_speed= as.numeric(sprint_speed)
)
#Metric for measurement (scoring using this?): https://razzball.com/points-leagues-her-legs-spreadsheet-out-before-me/
#on overage how often does x lead to a points


#RUN (+1), RBI (+1), 1B (+1), 2B (+2), 3B (+3), HR (+4), BB (+1), KO (-1), HBP (+1), SB (+2), CS (-1), SF (+1)
#WIN (+5), LOSS (-5), IP (+3), K (+1), BB (-1), SAVE (+7), BLOWN SAVE (-3), ER (-1), HIT (-1), IP (+3)

#Or create a rankings system

#Value by Position
#Fix team statistics

Batting_Statcast3

```




### Create Model File - use current statcast metrics and lagged other variables

#### Create Player Indicators, or maybe just look-up the ones I created already

##### Create indicator for improvment or decrease in statcast stats - including speed metrics, year indicator - ball park factor = avg and lahman  

###### Github and correlations

* Singles correlation to R and RBIs and SBs as well as average, same with other hit types

*  Linear regression for each of the hit types to points scored  

#### Runs Model 1
```{r}
#Linear model for value of each hit
library(caret)



y_col = Batting_Statcast3$R

x_col = (Batting_Statcast3 %>% 
  select(x1h,X2B,X3B,HR,BB,HBP,SO, CS, GIDP))

datalm_R = cbind(y_col,x_col)

lm2 = train(y_col~., datalm_R, method = "lm" )

summary(lm2)

#lm1 = train(y_col~., datalm, method = "rf" )

#lm1$modelInfo$varImp(X2B)

#lm1

```

#### Runs model with statcast variables
```{r}

y_col = Batting_Statcast3$R

x_col = (Batting_Statcast3 %>% 
  select(x1h,X2B,X3B,HR,BB,IBB,HBP,SO, GIDP,SB,sprint_speed,exit_velocity_avg))

datalm_R = na.omit(cbind(y_col,x_col))

#Add speed variables
lm3 = train(y_col~., datalm_R, method = "lm" )

summary(lm3)


```
#### RBI Model

```{r}
y_col = Batting_Statcast3$RBI

x_col = Batting_Statcast3 %>% 
  select(x1h,X2B,X3B,HR,BB,HBP,SO, CS, GIDP)

datalm_RBI = cbind(y_col,x_col)

lm4 = train(y_col~., datalm_RBI, method = "lm" )

summary(lm4)

```

#### RBI Model - using statcast variables

```{r}


y_col = Batting_Statcast3$RBI

x_col = (Batting_Statcast3 %>% 
  select(x1h,X2B,X3B,HR,IBB, CS, GIDP,sprint_speed,exit_velocity_avg))

datalm_R = na.omit(cbind(y_col,x_col))

#Add speed variables
lm5 = train(y_col~., datalm_R, method = "lm" )

summary(lm5)


```


#### HR Model - using statcast variables  

```{r}

y_col = Batting_Statcast3$HR

x_col = (Batting_Statcast3 %>% 
  select(x1h,X2B,IBB, GIDP,exit_velocity_avg,barrel_batted_rate,sweet_spot_percent,launch_angle_avg, solidcontact_percent))

datalm_R = na.omit(cbind(y_col,x_col))

#Add speed variables
lm6 = train(y_col~., datalm_R, method = "lm" )

summary(lm6)


```




#### SB Model - using statcast variables


```{r}


#Can't steal after a double hehe

y_col = Batting_Statcast3$SB

x_col = (Batting_Statcast3 %>% 
  select(x1h,X3B, CS, GIDP,sprint_speed, n_bolts, BB
      ))

datalm_R = na.omit(cbind(y_col,x_col))

#Add speed variables
lm7 = train(y_col~., datalm_R, method = "lm" )

summary(lm7)


```

#### BA Model - using statcast variables


```{r}


y_col = Batting_Statcast3$gpa

x_col = (Batting_Statcast3 %>% 
  select(x1h,
         #X3B,
         HR,BB,SO,GIDP,flareburner_percent, exit_velocity_avg,launch_angle_avg,sprint_speed, sweet_spot_percent, barrel_batted_rate, poorlytopped_percent, poorlyweak_percent,     hard_hit_percent,PF_SC
      ))

datalm_R = na.omit(cbind(y_col,x_col))

#Add speed variables
lm8 = train(y_col~., datalm_R, method = "lm" )

summary(lm8)






```

#### Worth of each stat
```{r}

SB_worth = 162/max(Batting_Statcast3$SB)

HR_worth = 162/max(Batting_Statcast3$HR)

ba_worth = 162/max(Batting_Statcast3$ba)/max(Batting_Statcast3$gpa)

RBI_worth = 162/max(Batting_Statcast3$RBI)

R_worth = 162/max(Batting_Statcast3$R)

Worth_vector = cbind(SB_worth,HR_worth ,ba_worth,RBI_worth,R_worth)



```


#### Coefficent Gathering  

```{r}

BA_model= cbind(as.data.frame(attr(lm8$terms , "term.labels")),as.data.frame(summary(lm8)$coefficients)[-1,1])
names(BA_model) = c("Variable","Coef")

BA_model2=
BA_model %>% 
  mutate(
  Worth=  Coef* ba_worth
  )


RUNS_model= cbind(as.data.frame(attr(lm3$terms , "term.labels")),as.data.frame(summary(lm3)$coefficients)[-1,1])
names(RUNS_model) = c("Variable","Coef")

RUNS_model2=
RUNS_model %>% 
  mutate(
  Worth=  Coef* R_worth
  )



SB_model= cbind(as.data.frame(attr(lm7$terms , "term.labels")),as.data.frame(summary(lm7)$coefficients)[-1,1])
names(SB_model) = c("Variable","Coef")

SB_model2=
SB_model %>% 
  mutate(
  Worth=  Coef* SB_worth
  )


HR_model= cbind(as.data.frame(attr(lm6$terms , "term.labels")),as.data.frame(summary(lm6)$coefficients)[-1,1])
names(HR_model) = c("Variable","Coef")

HR_model2=
HR_model %>% 
  mutate(
  Worth=  Coef* HR_worth
  )


RBI_model= cbind(as.data.frame(attr(lm5$terms , "term.labels")),as.data.frame(summary(lm5)$coefficients)[-1,1])
names(RBI_model) = c("Variable","Coef")

RBI_model2=
RBI_model %>% 
  mutate(
  Worth=  Coef* RBI_worth
  )


Total_worth = rbind(BA_model2,SB_model2,HR_model2,RBI_model2,RBI_model2)

Sum_worth = 
Total_worth %>%
  group_by(Variable) %>%
  summarise(add_worth = sum(Worth))

```


#Re-Assess Hitting Score Metric
```{r}
defaultW <- getOption("warn") 
options(warn = -1) 
#Create metrics for creating model
#consider adding the plus_statistics which are indexed to the league average
Batting_Statcast3 = Batting_Statcast2 %>% 
  mutate(
    x1h = H - X2B-X3B - HR,
    ba = H/AB,
    slg = (x1h+(X2B)+(X3B*2)+(HR*3))/AB,
    obp = (H+BB+HBP)/(AB+BB+HBP+SF),
    ops = obp+slg,
    iso = ((X2B)+(X3B*2)+(HR*3))/AB,
    gpa = (obp*1.8 + slg)/4,
    ab_per_hr = ifelse(HR < 1 ,0,AB/HR),
    team_x1h = T_H - T_X2B-T_X3B - T_HR,
    HBP_perc = HBP/AB,
    BB_perc = BB/AB,
    IBB_perc = IBB/AB,
    RBI_perc = RBI/AB,
    HR_perc = HR/AB,
    SO_perc = SO/AB,
    CS_perc = CS/G,
    SB_perc = SB/G,
    GIDP_perc = GIDP/AB,
    #note: woba is already included in statcast
    teamW_perc = Team_W/T_G,
    teamL_perc = Team_L/T_G,
    team_AVG = T_H/T_AB,
    team_slg = (team_x1h+(T_X2B)+(T_X3B*2)+(T_HR*3))/T_AB,
    slg_share =(x1h+(X2B)+(X3B*2)+(HR*3))/ (team_x1h+(T_X2B)+(T_X3B*2)+(T_HR*3)) ,
    team_iso = ((T_X2B)+(T_X3B*2)+(T_HR*3))/AB, 
    xba= as.numeric(xba),
    xslg= as.numeric(xslg),
    woba= as.numeric(woba),
    xwoba= as.numeric(xwoba),
    xobp= as.numeric(xobp),
    xiso= as.numeric(xiso),
    xbadiff= as.numeric(xbadiff),
    xslgdiff= as.numeric(xslgdiff),
    wobadif= as.numeric(wobadif),
    
    exit_velocity_avg= as.numeric(exit_velocity_avg),
    launch_angle_avg= as.numeric(launch_angle_avg),
    
    sweet_spot_percent = as.numeric(sweet_spot_percent),
    barrel_batted_rate= as.numeric(barrel_batted_rate),
    solidcontact_percent= as.numeric(solidcontact_percent),
    flareburner_percent= as.numeric(flareburner_percent),
    poorlyunder_percent= as.numeric(poorlyunder_percent),
    poorlytopped_percent= as.numeric(poorlytopped_percent),
    poorlyweak_percent= as.numeric(poorlyweak_percent),
    hard_hit_percent= as.numeric(hard_hit_percent),
    
    n_bolts= as.numeric(n_bolts),
    hp_to_1b= as.numeric(hp_to_1b),
    sprint_speed= as.numeric(sprint_speed),
    hitting_score1 = (1*R)+(1*x1h)+(2*X2B)+(3*X3B)+(4*HR) +
  (BB*0.25) + (SO*-0.50) + (HBP *0.25) + (SB *1.5) + (CS*-0.5) + (SF *1) + (GIDP * -1),
    hitting_score2 = (SB_worth*SB)+(HR_worth*HR)+(RBI_worth*RBI)+(ba_worth*ba)+(R_worth*R)+(barrel_batted_rate*4.66516154275165)+
(BB*0.55560592809121)+
(CS*2.52944003301411)+
(exit_velocity_avg*0.552642412438484)+
(flareburner_percent*1.63737059222312)+
(GIDP*0.425322605140042)+
(hard_hit_percent*0.550192443423582)+
(HR*5.11825743321138)+
(IBB*2.28231931472431)+
(launch_angle_avg*1.32159510336231)+
(ifelse(is.na(n_bolts),0,n_bolts*0.447239403616531))+
(PF_SC*23.563526411751)+
(poorlytopped_percent*0.959418886528)+
(poorlyweak_percent*0.975982986566501)+
(SO*-0.458435935570646)+
(solidcontact_percent*0.426263636787222)+
(ifelse(is.na(sprint_speed),26*2.70339379878721,sprint_speed*2.70339379878721))+
(sweet_spot_percent*0.407979625526337)+
(x1h*1.19175976745105)+
(X2B*2.35736214738333)+
(X3B*1.46459272393738)
)

#defaultW <- getOption("warn") 
#options(warn = -1) 

options(warn = defaultW)
```

### FIgure out average decrease in stats YoY for projections?

### Lagged Variables

```{r}

#Create lagged variables grouping by year and player

Batting_Statcast3$lag_hitting_score2 =  c(NA, Batting_Statcast3$hitting_score2[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_hitting_score2[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_ba =  c(NA, Batting_Statcast3$ba[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_ba[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_slg =  c(NA, Batting_Statcast3$slg[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_slg[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_obp =  c(NA, Batting_Statcast3$obp[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_obp[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_iso =  c(NA, Batting_Statcast3$iso[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_iso[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_gpa =  c(NA, Batting_Statcast3$gpa[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_gpa[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_ab_per_hr =  c(NA, Batting_Statcast3$ab_per_hr[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_ab_per_hr[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_woba =  c(NA, Batting_Statcast3$woba[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_woba[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_HBP_perc =  c(NA, Batting_Statcast3$HBP_perc[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_HBP_perc[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA


Batting_Statcast3$lag_BB_perc =  c(NA, Batting_Statcast3$BB_perc[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_BB_perc[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_IBB_perc =  c(NA, Batting_Statcast3$IBB_perc[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_IBB_perc[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_RBI_perc =  c(NA, Batting_Statcast3$RBI_perc[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_RBI_perc[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_HR_perc =  c(NA, Batting_Statcast3$HR_perc[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_HR_perc[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_SO_perc =  c(NA, Batting_Statcast3$SO_perc[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_SO_perc[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_SB_perc =  c(NA, Batting_Statcast3$SB_perc[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_SB_perc[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_HBP_perc =  c(NA, Batting_Statcast3$HBP_perc[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_HBP_perc[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

Batting_Statcast3$lag_slg_share =  c(NA, Batting_Statcast3$slg_share[-nrow(Batting_Statcast2)])
Batting_Statcast3$lag_slg_share[which(!duplicated(Batting_Statcast3$New_Player_ID))] <- NA

#names1 = as.data.frame(names(Batting_Statcast3))

write.csv(names1,"names_dataset.csv")

```



#### Create Model File

```{r}

#Indicators

player_ind = read_csv(
  "Player_ind.csv"
)


Batting_Statcast4 <- sqldf("
    select a.*, b.IND from 
    Batting_Statcast3 a, player_ind b
    on a.New_Player_ID = b.New_Player_ID 
                           ")


Batting_Statcast_MF_Init =
Batting_Statcast4 %>% 
  select(
    hitting_score2,c(3,23,24,26:28,32,44,84:95,96,115,117,124:139)
  )

skim(Batting_Statcast_MF_Init)

```


#### Impute NAs to be average for that player potentally, right now just see base model

```{r}

set.seed(100)  # For reproducibility
# Create index for testing and training data
inTrain <- createDataPartition(y = Batting_Statcast_MF_Init$hitting_score2, p = 0.8, list = FALSE)
# subset power_plant data to training
tr <- Batting_Statcast_MF_Init[inTrain,]
# subset the rest to test
 te <- Batting_Statcast_MF_Init[-inTrain,]


```


##### Convert the training and testing sets into DMatrixes: DMatrix is the recommended class in xgboost.   

*cleaning documentations:*  https://www.kaggle.com/pelkoja/visual-xgboost-tuning-with-caret  

```{r}
X_train = (tr %>% select(-hitting_score2))
y_train = tr$hitting_score2
X_test = (te %>% select(-hitting_score2))
y_test = te$hitting_score2


treat_plan <- vtreat::designTreatmentsZ(
  dframe = tr, # training data
  varlist = colnames(tr) %>% .[. != "hitting_score1"], # input variables = all training data columns, except random
  codeRestriction = c("clean", "isBAD", "lev"), # derived variables types (drop cat_P)
  verbose = FALSE) # suppress messages



```
* clean stands for cleaned numerical variable, isBAD indicates that a value replacement has occurred (which indicates a missing value in this case), and lev is a binary indicator whether a particular value of that categorical variable was present.  

```{r}
score_frame <- treat_plan$scoreFrame %>% 
  select(varName, origName, code)

head(score_frame)
```

#test model without using log variable perhaps

```{r}
tr_treated <- vtreat::prepare(treat_plan, tr)
te_treated <- vtreat::prepare(treat_plan, te)


#Convert dependant to log score
tr_treated$hitting_score2 <- log(tr_treated$hitting_score2)

dim(tr_treated)
```

#### In addition, we’ll be taking out a hold-out set. This is because looking at the cross-validated RMSE can give over-optimistic view on the model performance, and we can now test the model performance with unseen data without having to submit anything to Kaggle. In order not to sacrifice too much training data, we’ll be taking an 80/20 split with `dplyr`:

```{r}
tr_holdout <- dplyr::sample_frac(tr_treated, 0.2)
hid <- as.numeric(rownames(tr_holdout))
tr_treated <- tr_treated[-hid, ]
```


```{r}
ggplot2::qplot(tr_holdout$hitting_score2, main="Hold-out Set") + geom_histogram(colour="black", fill="grey") + theme_bw()

ggplot2::qplot(tr_treated$hitting_score2, main="Total Set") + geom_histogram(colour="black", fill="grey") + theme_bw()

```

##### To keep things simple with modeling, we’ll turn the traninig data into simple input variables for `caret::train`, dropping the response variable and converting the data frame to a matrix:

```{r}

input_x <- as.matrix(select(tr_treated, -hitting_score2))
input_y <- tr_treated$hitting_score2

```


###### Linear Model first  

* Look at value with the highest correlation
```{r}
(mcor <- tr_treated %>% 
{cor(select(., -hitting_score2), .$hitting_score2, method = "spearman")} %>% 
    .[. == max(.), ])




```

```{r}
lin_x <- tr_treated[, which(names(tr_treated) == names(mcor))]
lin_y <- tr_treated$hitting_score2

ggplot2::ggplot() +
  aes(x = lin_x, y = lin_y) +
  geom_jitter() +
  xlab(names(mcor)) +
  ylab("hitting_score2 (log)") +
  theme_bw() +
  geom_smooth(method = "lm")

```

##### And train a linear model with lm() using expected slugging as the explanatory variable:

```{r}

linear_base <- lm(paste0("hitting_score2 ~ ", names(mcor)),data = tr_treated)

summary(linear_base)

```

#### XGBoost with Default Hyperparameters

```{r}


grid_default <- expand.grid(
  nrounds = 100,
  max_depth = 6,
  eta = 0.3,
  gamma = 0,
  colsample_bytree = 1,
  min_child_weight = 1,
  subsample = 1
)

train_control <- caret::trainControl(
  method = "none",
  verboseIter = FALSE, # no training log
  allowParallel = TRUE # FALSE for reproducible results 
)

xgb_base <- caret::train(
  x = input_x,
  y = input_y,
  trControl = train_control,
  tuneGrid = grid_default,
  method = "xgbTree",
  verbose = TRUE
)


```


##### Next, we build tuning grid for caret to explore between different hyperparameter values. To get started we’re using some suggestions from:   https://www.slideshare.net/OwenZhang2/tips-for-data-science-competitions/14.

```{r}

defaultW <- getOption("warn") 
options(warn = -1) 



# maximum number of trees
nrounds <- 1000

# note to start nrounds from 200, as smaller learning rates result in errors so
# big with lower starting points that they'll mess the scales
tune_grid <- expand.grid(
  nrounds = seq(from = 200, to = nrounds, by = 50),
  eta = c(0.025, 0.05, 0.1, 0.2, 0.3),
  max_depth = c(2, 4, 5, 6, 8, 10),
  gamma = 0,
  colsample_bytree = 1,
  min_child_weight = 1,
  subsample = 1
)

tune_control <- caret::trainControl(
  method = "cv", # cross-validation
  number = 5, # with n folds 
  #index = createFolds(tr_treated$Id_clean), # fix the folds
  verboseIter = FALSE, # no training log
  allowParallel = TRUE # FALSE for reproducible results 
)



xgb_tune <- caret::train(
  x = input_x,
  y = input_y,
  trControl = tune_control,
  tuneGrid = tune_grid,
  method = "xgbTree",
  verbose = FALSE
  ,verbosity = 0
)
options(warn = defaultW)

```


#### plot for data


```{r}

# helper function for the plots
tuneplot <- function(x, probs = .90) {
  ggplot(x) +
    coord_cartesian(ylim = c(quantile(x$results$RMSE, probs = probs), min(x$results$RMSE))) +
    theme_bw()
}

tuneplot(xgb_tune)

xgb_tune$bestTune

```


#### Second Tuning: Maximum Depth and Minimum Child Weight

After fixing the learning rate to 0.1 and we’ll also set maximum depth to 3 +-1 (or +2 if max_depth == 2) to experiment a bit around the suggested best tune in previous step. Then, well fix maximum depth and minimum child weigh

```{r}
tune_grid2 <- expand.grid(
  nrounds = seq(from = 50, to = nrounds, by = 50),
  eta = xgb_tune$bestTune$eta,
  max_depth = ifelse(xgb_tune$bestTune$max_depth == 2,
    c(xgb_tune$bestTune$max_depth:4),
    xgb_tune$bestTune$max_depth - 1:xgb_tune$bestTune$max_depth + 1),
  gamma = 0,
  colsample_bytree = 1,
  min_child_weight = c(1, 2, 3),
  subsample = 1
)

xgb_tune2 <- caret::train(
  x = input_x,
  y = input_y,
  trControl = tune_control,
  tuneGrid = tune_grid2,
  method = "xgbTree",
  verbose = TRUE
)

tuneplot(xgb_tune2)

xgb_tune2$bestTune
```


##### Third Tuning: Column and Row Sampling

```{r}

tune_grid3 <- expand.grid(
  nrounds = seq(from = 50, to = nrounds, by = 50),
  eta = xgb_tune$bestTune$eta,
  max_depth = xgb_tune2$bestTune$max_depth,
  gamma = 0,
  colsample_bytree = c(0.4, 0.6, 0.8, 1.0),
  min_child_weight = xgb_tune2$bestTune$min_child_weight,
  subsample = c(0.5, 0.75, 1.0)
)

xgb_tune3 <- caret::train(
  x = input_x,
  y = input_y,
  trControl = tune_control,
  tuneGrid = tune_grid3,
  method = "xgbTree",
  verbose = TRUE
)

tuneplot(xgb_tune3, probs = .95)

xgb_tune3$bestTune

```


##### Fourth Tuning: Gamma  
Next, we again pick the best values from previous step, and now will see whether changing the gamma has any effect on the model fit:
```{r}
tune_grid4 <- expand.grid(
  nrounds = seq(from = 50, to = nrounds, by = 50),
  eta = xgb_tune$bestTune$eta,
  max_depth = xgb_tune2$bestTune$max_depth,
  gamma = c(0, 0.05, 0.1, 0.5, 0.7, 0.9, 1.0),
  colsample_bytree = xgb_tune3$bestTune$colsample_bytree,
  min_child_weight = xgb_tune2$bestTune$min_child_weight,
  subsample = xgb_tune3$bestTune$subsample
)

xgb_tune4 <- caret::train(
  x = input_x,
  y = input_y,
  trControl = tune_control,
  tuneGrid = tune_grid4,
  method = "xgbTree",
  verbose = TRUE
)

tuneplot(xgb_tune4)

xgb_tune4$bestTune
```


##### Fifth Tuning: Reducing the Learning Rate  
Now, we have tuned the hyperparameters and can start reducing the learning rate to get to the final model:  

```{r}
tune_grid5 <- expand.grid(
  nrounds = seq(from = 100, to = 10000, by = 100),
  eta = c(0.01, 0.015, 0.025, 0.05, 0.1),
  max_depth = xgb_tune2$bestTune$max_depth,
  gamma = xgb_tune4$bestTune$gamma,
  colsample_bytree = xgb_tune3$bestTune$colsample_bytree,
  min_child_weight = xgb_tune2$bestTune$min_child_weight,
  subsample = xgb_tune3$bestTune$subsample
)

xgb_tune5 <- caret::train(
  x = input_x,
  y = input_y,
  trControl = tune_control,
  tuneGrid = tune_grid5,
  method = "xgbTree",
  verbose = TRUE
)

tuneplot(xgb_tune5)

xgb_tune5$bestTune
```


#### Fitting Final Model

```{r}

(final_grid <- expand.grid(
  nrounds = xgb_tune5$bestTune$nrounds,
  eta = xgb_tune5$bestTune$eta,
  max_depth = xgb_tune5$bestTune$max_depth,
  gamma = xgb_tune5$bestTune$gamma,
  colsample_bytree = xgb_tune5$bestTune$colsample_bytree,
  min_child_weight = xgb_tune5$bestTune$min_child_weight,
  subsample = xgb_tune5$bestTune$subsample
))

(xgb_model <- caret::train(
  x = input_x,
  y = input_y,
  trControl = train_control,
  tuneGrid = final_grid,
  method = "xgbTree",
  verbose = TRUE
))

```

#### Score model
```{r}


holdout_x <- select(tr_holdout, -hitting_score2)
holdout_y <- tr_holdout$hitting_score2

(linear_base_rmse <- ModelMetrics::rmse(holdout_y, predict(linear_base, newdata = holdout_x)))

(xgb_base_rmse <- ModelMetrics::rmse(holdout_y, predict(xgb_base, newdata = holdout_x)))

(xgb_model_rmse <- ModelMetrics::rmse(holdout_y, predict(xgb_model, newdata = holdout_x)))


```

#### Check on Test Data

```{r}


y_pred_test <- predict(xgb_model, data.matrix(te_treated))

test_stats= cbind(log(te_treated$hitting_score2),y_pred_test)

test_statsR2 = cor(test_stats[,1],test_stats[,2])^2

print(test_statsR2)


y_pred_train <- predict(xgb_model, data.matrix(tr_treated))

train_stats = cbind((tr_treated$hitting_score2),y_pred_train)

train_statsR2 = cor(train_stats[,1],train_stats[,2])^2

print(train_statsR2)


holdout_x <- select(te_treated, -hitting_score2)
holdout_y <- log(te_treated$hitting_score2)

(xgb_model_rmse <- ModelMetrics::rmse(holdout_y, predict(xgb_model, newdata = holdout_x)))

holdout_x <- select(tr_treated, -hitting_score2)
holdout_y <- tr_treated$hitting_score2

(xgb_model_rmse <- ModelMetrics::rmse(holdout_y, predict(xgb_model, newdata = holdout_x)))


```

### Additional Metrics to check

```{r}
varImp(xgb_model,scale=FALSE)



```



### Plot Train Results

```{r}

par(mfrow=c(2,1))

ggplot2::ggplot() +
  aes(x = train_stats[,1], y = train_stats[,2]) +
  geom_jitter() +
  xlab("Predicted Values") +
  ylab("Actual Values") +
  ggtitle("Results of Model on Training Data")+
  theme(plot.title = element_text(hjust = 0.5,size = 22,color ="Steel Blue"))+
  geom_smooth(method = "lm")



```





### Plot Test Results


```{r}

ggplot2::ggplot() +
  aes(x = test_stats[,1], y = test_stats[,2]) +
  geom_jitter() +
  xlab("Predicted Values") +
  ylab("Actual Values") +
  ggtitle("Results of Model on Test Data")+
  theme(plot.title = element_text(hjust = 0.5,size = 22,color ="steel blue"))+
  geom_smooth(method = "lm")



```





